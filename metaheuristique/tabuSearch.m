% Définition des coordonnées des villes

maroc_villes = {
    'Casablanca', 33.5333, -7.5833;
    'Fès', 34.0433, -5.0033;
    'Marrakech', 31.6300, -8.0089;
    'Tangier', 35.7767, -5.8039;
    'Sale', 34.0333, -6.8000;
    'Rabat', 34.0209, -6.8416;
    'Meknès', 33.8950, -5.5547;
    'Oujda-Angad', 34.6867, -1.9114;
    'Kenitra', 34.2500, -6.5833;
    'Agadir', 30.4333, -9.6000;
    'Tétouan', 35.5667, -5.3667;
    'Taourirt', 34.4169, -2.8850;
    'Temara', 33.9267, -6.9122;
    'Safi', 32.2833, -9.2333;
    'Khénifra', 32.9394, -5.6675;
    'El Jadid', 33.2333, -8.5000;
    'Laâyoune', 27.1536, -13.2033;
    'Mohammedia', 33.6833, -7.3833;
    'Kouribga', 32.8833, -6.9167;
    'Béni Mellal', 32.3394, -6.3608;
    'Ait Melloul', 30.3342, -9.4972;
    'Nador', 35.1667, -2.9333;
    'Taza', 34.2167, -4.0167;
    'Settat', 33.0000, -7.6167;
    'Barrechid', 33.2667, -7.5833;
    'Al Khmissat', 33.8167, -6.0667;
    'Inezgane', 30.3658, -9.5381;
    'Ksar El Kebir', 35.0090, -5.9000;
    'My Drarga', 30.3800, -9.4800;
    'Larache', 35.1833, -6.1500;
    'Guelmim', 28.9833, -10.0667;
    'Berkane', 34.9167, -2.3167;
    'Ad Dakhla', 23.7081, -15.9456;
    'Bouskoura', 33.4489, -7.6486;
    'Al Fqih Ben Çalah', 32.5000, -6.5333;
    'Oued Zem', 32.8667, -6.5667;
    'Sidi Slimane', 34.2600, -5.9200;
    'Errachidia', 31.9319, -4.4244;
    'Guercif', 34.2333, -3.3667;
    'Oulad Teïma', 30.4000, -9.2167;
    'Ben Guerir', 32.2300, -7.9500;
    'Sefrou', 33.8300, -4.8300;
    'Fnidq', 35.8500, -5.3500;
    'Sidi Qacem', 34.2167, -5.7000;
    'Tiznit', 29.7167, -9.7167;
    'Moulay Abdallah', 33.1978, -8.5883;
    'Youssoufia', 32.2500, -8.5333;
    'Martil', 35.6167, -5.2667;
    'Aïn Harrouda', 33.6372, -7.4483;
    'Souq Sebt Oulad Nemma', 32.2948, -6.7007;
    'Skhirate', 33.8500, -7.0300;
    'Ouezzane', 34.8000, -5.5833;
    'Sidi Yahya Zaer', 33.7105, -6.8831;
    'Al Hoceïma', 35.2472, -3.9322;
    'M’diq', 35.6858, -5.3253;
    'Midalt', 32.6800, -4.7300;
    'Azrou', 33.4417, -5.2247;
    'El Kelaa des Srarhna', 32.0481, -7.4083;
    'Ain El Aouda', 33.8111, -6.7922;
    'Beni Yakhlef', 33.6555, -7.3221;
    'Ad Darwa', 33.4167, -7.5333;
    'Al Aaroui', 35.0029, -3.0311;
    'Qasbat Tadla', 32.6000, -6.2667;
    'Boujad', 32.7667, -6.4000;
    'Jerada', 34.3117, -2.1636;
    'Mrirt', 33.1667, -5.5667;
    'El Aïoun', 34.5852, -2.5056;
    'Azemmour', 33.2878, -8.3422;
    'Temsia', 30.3600, -9.4140;
    'Zagora', 30.3306, -5.8381;
    'Ait Ourir', 31.5644, -7.6628;
    'Aziylal', 31.9669, -6.5694;
    'Sidi Yahia El Gharb', 34.3058, -6.3058;
    'Biougra', 30.2144, -9.3708;
    'Zaïo', 34.9333, -2.7333;
    'Aguelmous', 33.1500, -5.8333;
    'El Hajeb', 33.6928, -5.3711;
    'Zeghanghane', 35.1500, -3.0000;
    'Imzouren', 35.1500, -3.8500;
    'Tit Mellil', 33.5533, -7.4822;
    'Mechraa Bel Ksiri', 34.5600, -5.9500;
    'Al ’Attawia', 31.8347, -7.3125;
    'Demnat', 31.7311, -7.0361;
    'Arfoud', 31.4361, -4.2328;
    'Tameslouht', 31.5000, -8.1000;
    'Bou Arfa', 32.5309, -1.9650;
    'Sidi Smai’il', 32.8167, -8.5000;
    'Souk et Tnine Jorf el Mellah', 34.4833, -5.5169;
    'Mehdya', 34.2597, -6.6500;
    'Aïn Taoujdat', 33.9333, -5.2167;
    'Chichaoua', 31.5333, -8.7667;
    'Tahla', 34.0500, -4.4200;
    'Oulad Yaïch', 32.4167, -6.3333;
    'Moulay Bousselham', 34.8786, -6.2933;
    'Iheddadene', 35.1500, -2.9667;
    'Missour', 33.0500, -3.9833;
    'Zawyat ech Cheïkh', 32.6414, -5.9206;
    'Bouknadel', 34.1333, -6.7333;
    'Oulad Tayeb', 33.9598, -4.9954;
    'Oulad Barhil', 30.6408, -8.4750;
    'Bir Jdid', 33.3737, -8.0002;
    'Tifariti', 26.1580, -10.5670
};

villes = cell2mat(maroc_villes(:, 2:3));

% calcul de distance pour toutes les ville 
n = size(maroc_villes, 1);
distances = zeros(n, n);
for i = 1:n
    for j = 1:n
        distances(i, j) = norm(villes(i, :) - villes(j, :));
    end
end

% les Parametres de  recherche tabou

taille_de_T = 10;
k = 1000; % Nombre d'itérations

% Initialisation de la solution

solution_courante = randperm(n);
cout_courant = calculer_cout(solution_courante, distances);

% Initialisation de T
T = cell(taille_de_T, 1);

% Boucle principale de la recherche tabou
for iter = 1:k
    meilleur_voisin = [];
    meilleur_cout_voisin = Inf;
    
    % Recherche du meilleur voisin non tabou
    for i = 1:n-1
        for j = i+1:n
            voisin = solution_courante;
            voisin([i, j]) = voisin([j, i]);
            cout_voisin = calculer_cout(voisin, distances);

            if cout_voisin < meilleur_cout_voisin && ~est_dans_T(voisin, T)
                meilleur_voisin = voisin;
                meilleur_cout_voisin = cout_voisin;
            end
        end
    end
    
    % Mettre a jour la solution courante
    solution_courante = meilleur_voisin;
    cout_courant = meilleur_cout_voisin;
    
    % mettre a jour la liste tabou
    T = mettre_a_jour_T(T, solution_courante, taille_de_T);
end

% definier les noms des villes marocain 
villes_nom = maroc_villes(:, 1);

% trouver les noms baser sur les index
solution_villes_noms = villes_nom(solution_courante);

% Display the solution with city names
disp('Solution finale :');
disp(solution_villes_noms);
disp(['Coût final : ', num2str(cout_courant)]);

% est ce que la solution dans T : 
function est_tabou = est_dans_T(solution, T)
    est_tabou = any(cellfun(@(x) isequal(x, solution), T));
end

% Fonction pour mettre à jour la liste tabou (queue)
function nouvelle_T = mettre_a_jour_T(T, nouvelle_solution, taille_max)
    nouvelle_T = [T(2:end); {nouvelle_solution}];
    if length(nouvelle_T) < taille_max
        nouvelle_T = [nouvelle_T; {[]}];
    end
end

% Fonction pour calculer le coût d'une solution (distance totale parcouru)
function cout = calculer_cout(solution, distances)
    n = length(solution);
    cout = 0;
    for i = 1:n-1
        cout = cout + distances(solution(i), solution(i+1));
    end
    cout = cout + distances(solution(end), solution(1)); % Retour à la ville de départ
end
